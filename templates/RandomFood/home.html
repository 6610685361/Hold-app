{% extends "base.html" %}
{% block title %}Random Food{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-[300px_1fr] gap-4">
  <!-- Favorites sidebar -->
  <aside class="border rounded-xl bg-white p-3 h-[560px] overflow-hidden self-center">
    <h3 class="font-semibold mb-2">Favorites</h3>
    <ul id="favList" class="space-y-2 h-full overflow-y-auto pr-2"></ul>
  </aside>

  <!-- Main swipe section -->
  <section class="flex flex-col items-center justify-center relative">
    <form class="w-[420px] max-w-[92vw] mb-3 flex gap-2 items-center">
      {% csrf_token %}
      <!-- Category select -->
      <label class="text-sm mr-2">Category</label>
      <select id="filterCategory" class="rounded px-3 py-1 border">
        <option value="">All Categories</option>
        {% for c in categories %}
          <option value="{{ c.id }}">{{ c.name }}</option>
        {% endfor %}
      </select>

      <!-- Types select (multi-select) -->
      <label class="text-sm ml-2 mr-1">Type</label>
      <select id="filterTypes" multiple size="1" class="rounded px-4 py-1 border">
        {% for t in types %}
          <option value="{{ t.id }}">{{ t.name }}</option>
        {% endfor %}
      </select>

      <button type="button" id="btnApplyFilters" class="ml-5 px-3 py-1 rounded bg-sky-600 text-white">Apply</button>
      <button type="button" id="btnClearFilters" class="ml-1 px-3 py-1 rounded border">Clear</button>
    </form>

    <div id="stack" class="relative w-[420px] max-w-[92vw] h-[560px]"></div>

    <div class="flex gap-3 w-[420px] max-w-[92vw] mt-3">
      <button type="button" id="btnSkip" class="flex-1 py-2.5 rounded-lg bg-red-500 text-white">Nah</button>
      <button type="button" id="btnFav"  class="flex-1 py-2.5 rounded-lg bg-yellow-400 text-white">‚ù§Ô∏è Favorite</button>
      <button type="button" id="btnLike" class="flex-1 py-2.5 rounded-lg bg-green-600 text-white">Take it</button>
    </div>

    <!-- Overlay -->
    <div id="resultOverlay"
         class="fixed inset-0 hidden opacity-0 transition-opacity duration-300
                flex flex-col items-center justify-center bg-black/80 backdrop-blur-sm z-[9999] p-6">
      <div class="flex flex-col items-center justify-center text-center">
        <img id="resultImage" src=""
             class="w-[420px] h-[300px] max-w-[90vw] max-h-[70vh]
                    object-cover rounded-2xl shadow-2xl mb-5 border-4 border-white/40
                    transform transition-transform duration-300 scale-95" />
        <div id="resultText" class="text-white text-xl font-semibold mb-6"></div>
        <div class="flex gap-5">
          <button id="overlayFav" class="px-6 py-2.5 rounded-lg bg-yellow-400 text-black font-semibold shadow-md">‚ù§Ô∏è Favorite</button>
          <button id="overlayOK"  class="px-6 py-2.5 rounded-lg bg-green-600 text-white font-semibold shadow-md">OK</button>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
const API_BATCH     = "{% url 'api_random_food_batch' %}";
const API_FAV       = "{% url 'api_add_favorite' %}";
const API_GET_FAVS  = "{% url 'api_get_favorites' %}";

const stackEl       = document.getElementById('stack');
const btnLike       = document.getElementById('btnLike');
const btnSkip       = document.getElementById('btnSkip');
const btnFav        = document.getElementById('btnFav');
const favList       = document.getElementById('favList');

const overlay       = document.getElementById('resultOverlay');
const resultImage   = document.getElementById('resultImage');
const resultText    = document.getElementById('resultText');
const overlayFav    = document.getElementById('overlayFav');
const overlayOK     = document.getElementById('overlayOK');

const filterCategory = document.getElementById('filterCategory');
const filterTypes = document.getElementById('filterTypes');
const btnApplyFilters = document.getElementById('btnApplyFilters');
const btnClearFilters = document.getElementById('btnClearFilters');

let stack = [];
let offset = 0;
let doneLoading = false;
const VISIBLE_CARDS = 3;

/* ===== Helpers ===== */
function csrf() {
  return document.querySelector('input[name=csrfmiddlewaretoken]')?.value || '';
}
const topCard = () => stack[0] || null;

/* ===== Favorites sidebar ===== */
function addToSidebar(card) {
  if (!card) return;
  if (document.getElementById(`fav-${card.id}`)) return;

  const li = document.createElement('li');
  li.id = `fav-${card.id}`;
  li.className = "flex items-center gap-2 border-b pb-1";

  li.innerHTML = `
    <img src="${card.image_url||''}" class="w-10 h-10 rounded object-cover border" />
    <span class="text-sm font-medium truncate flex-1">${card.name}</span>

    <button
      onclick="removeFavorite(${card.id})"
      class="text-red-500 hover:text-red-700 font-bold text-lg px-2"
      title="Remove from favorites"
    >
      ‚úï
    </button>
  `;

  favList.appendChild(li);
}

/* ===== Add favorite ===== */
async function addFavorite(card) {
  if (!card) return;
  if (document.getElementById(`fav-${card.id}`)) return;
  overlayFav.disabled = true;
  overlayFav.textContent = "‚ù§Ô∏è Added";

  await fetch(API_FAV, {
    method: 'POST',
    headers: {'Content-Type':'application/json', 'X-CSRFToken': csrf()},
    credentials: 'include',
    body: JSON.stringify({ dish_id: card.id })
  });

  addToSidebar(card);
}

/* ===== Load existing favorites ===== */
async function loadFavorites() {
  const r = await fetch(API_GET_FAVS, {credentials:'include'});
  const data = await r.json();
  (data.favorites || []).forEach(card => addToSidebar(card));
}

/* ===== Build query params from filters ===== */
function buildFilterQuery() {
  const params = new URLSearchParams();
  // Category (single)
  if (filterCategory && filterCategory.value) {
    params.set("category", filterCategory.value);
  }
  // Types (multiple)
  if (filterTypes) {
    const selected = Array.from(filterTypes.selectedOptions).map(o => o.value).filter(v => v);
    if (selected.length) {
      params.set("types", selected.join(","));
    }
  }
  return params.toString();
}

/* ===== Reset stack when filters change ===== */
function resetStackAndReload() {
  stack = [];
  offset = 0;
  doneLoading = false;
  stackEl.innerHTML = '';
  loadBatch();
}

/* ===== Event wiring for filter buttons ===== */
btnApplyFilters.addEventListener('click', () => {
  resetStackAndReload();
});

btnClearFilters.addEventListener('click', () => {
  filterCategory.value = "";
  // clear selected in multi select
  Array.from(filterTypes.options).forEach(o => o.selected = false);
  resetStackAndReload();
});

/* ===== Load batch (lazy-load) ===== */
async function loadBatch() {
  if (doneLoading) return;
  // fetch 10 at a time
  const params = new URLSearchParams();
  params.set("n", 10);
  params.set("offset", offset);

  // add filters
  const filterQuery = buildFilterQuery();
  if (filterQuery) {
    // append each filter param individually (API expects query params category & types)
    const fq = new URLSearchParams(filterQuery);
    for (const [k,v] of fq.entries()) params.set(k, v);
  }

  const url = `${API_BATCH}?${params.toString()}`;
  const r = await fetch(url, {credentials:'include'});
  const data = await r.json();
  const newCards = data.cards || [];
  stack.push(...newCards);
  offset += newCards.length;
  doneLoading = !!data.done;
  renderStack();
}

/* ===== Render stack ===== */
function renderStack() {
  stackEl.innerHTML = '';
  stack.slice(0, VISIBLE_CARDS).forEach((card, idx) => {
    const el = createCard(card);
    el.style.zIndex = 100 - idx;
    el.style.transform = `translateY(${idx*6}px) scale(${1 - idx*0.03})`;
    stackEl.appendChild(el);
    if (idx === 0) attachDrag(el, card.id);
  });
  if (!stack.length) {
    stackEl.innerHTML = `<div class="grid place-items-center w-full h-full rounded-xl border bg-white text-gray-600">No food left üéâ</div>`;
  }
}

/* ===== Create card element ===== */
function createCard(card) {
  const el = document.createElement('div');
  el.className = "absolute inset-0 rounded-2xl overflow-hidden bg-white shadow-2xl select-none transition";
  el.innerHTML = `
    <img src="${card.image_url||''}" class="absolute inset-0 w-full h-full object-cover" />
    <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
    <div class="absolute bottom-0 p-4 text-white">
      <h2 class="text-xl font-semibold">${card.name||''}</h2>
      <p class="opacity-90">${card.description||''}</p>
    </div>`;
  return el;
}

/* ===== Overlay ===== */
function showResult(card) {
  resultImage.src = card.image_url || '';
  resultText.textContent = card.name || '';
  overlay.classList.remove('hidden');
  requestAnimationFrame(() => overlay.style.opacity = '1');

  if (document.getElementById(`fav-${card.id}`)) {
    overlayFav.disabled = true;
    overlayFav.textContent = "‚ù§Ô∏è Added";
  } else {
    overlayFav.disabled = false;
    overlayFav.textContent = "‚ù§Ô∏è Favorite";
  }

  overlayFav.onclick = () => addFavorite(card);
  overlayOK.onclick = hideOverlay;
}

function hideOverlay() {
  overlay.style.opacity = '0';
  setTimeout(() => overlay.classList.add('hidden'), 300);
}

/* ===== Swipe logic with mouse + touch ===== */
function attachDrag(cardEl, id) {
  let startX = 0, dx = 0, dragging = false;

  function startDrag(x) {
    startX = x;
    dragging = true;
  }

  function moveDrag(x) {
    if (!dragging) return;
    dx = x - startX;
    cardEl.style.transform = `translateX(${dx}px) rotate(${dx/18}deg)`;
  }

  function endDrag() {
    if (!dragging) return;
    dragging = false;
    if (dx > 120) {
      animateSwipe(cardEl, "right");
    } else if (dx < -120) {
      animateSwipe(cardEl, "left");
    } else {
      cardEl.style.transform = 'translateX(0)';
    }
  }

  // Mouse events
  cardEl.addEventListener('mousedown', e => startDrag(e.clientX));
  window.addEventListener('mousemove', e => moveDrag(e.clientX));
  window.addEventListener('mouseup', endDrag);

  // Touch events
  cardEl.addEventListener('touchstart', e => startDrag(e.touches[0].clientX));
  window.addEventListener('touchmove', e => moveDrag(e.touches[0].clientX));
  window.addEventListener('touchend', endDrag);
}

/* ===== Swipe animation ===== */
function animateSwipe(cardEl, direction) {
  const card = topCard();
  if (!card) return;

  const xOffset = direction === "right" ? 400 : -400;
  cardEl.style.transition = "transform 0.3s ease-out, opacity 0.3s ease-out";
  cardEl.style.transform = `translateX(${xOffset}px) rotate(${direction === "right" ? 15 : -15}deg)`;
  cardEl.style.opacity = "0";

  setTimeout(() => {
    if (direction === "right") {
      showResult(card);
    }
    stack.shift();
    if (stack.length < VISIBLE_CARDS) loadBatch();
    renderStack();
  }, 300);
}

/* ===== Button handlers ===== */
btnLike.onclick = () => {
  const card = topCard();
  const el = stackEl.querySelector('.absolute'); // topmost card
  if (card && el) animateSwipe(el, "right");
};

btnSkip.onclick = () => {
  const card = topCard();
  const el = stackEl.querySelector('.absolute');
  if (card && el) animateSwipe(el, "left");
};

btnFav.onclick = () => {
  const card = topCard();
  if (card) addFavorite(card);
};

/* ===== Remove favorite ===== */

async function removeFavorite(foodId) {
  try {
    const res = await fetch(`remove-favorite/${foodId}/`, {
      method: "GET",
      credentials: "include",
    });

    const data = await res.json();
    if (data.ok) {
      const li = document.getElementById(`fav-${foodId}`);
      if (li) li.remove();
    }
  } catch (err) {
    console.error("Remove favorite failed:", err);
  }
}

/* ===== Init ===== */
loadBatch();
loadFavorites();
</script>
{% endblock %}
